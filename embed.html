<script src="chat_client.js"></script>

<form method="none" onsubmit="return sendText()">
  <label>Send message: <input id="input" /></label><input type="submit" value="Go"/>
  <pre id="output"></pre>
</form>

<script>
  /** example from https://javascript.info/websocket */

  let socket;

  function send_to_server(bytes) {
      socket.send(bytes);
  }

  function add_to_output(text) {
      const pre = document.querySelector("#output");
      pre.textContent += text + '\n';
  }
  
  function sendText() {
      let input = document.querySelector("#input");
      if (input.value.length > 0) {
          wasm_bindgen.handle_input(input.value);
      }
      input.value = "";
      return false;
  }
  
  function setUpWebSocket() {
      socket = new WebSocket(window.location.hostname==='localhost'? "ws://localhost:9001/" : "wss://www.redblobgames.com/ws/");
      
      socket.onopen = event => {
          console.log("Connected:", event);
          wasm_bindgen.connected();
          document.querySelector("#input").focus();
      };
      
      socket.onmessage = event => {
          let fileReader = new FileReader();
          fileReader.onload = e => wasm_bindgen.handle_message(new Uint8Array(e.target.result));
          fileReader.readAsArrayBuffer(event.data);
      };
      
      socket.onclose = event => {
          if (event.wasClean) {
              console.log(`Closed: code=${event.code} reason=${event.reason}`);
          } else {
              console.log(`Died: code=${event.code} reason=${event.reason}`);
          }
      };
      
      socket.onerror = error => {
          console.log(`Error: ${error.message}`);
      };
  }

  wasm_bindgen("chat_client_bg.wasm")
      .then(setUpWebSocket);
</script>
